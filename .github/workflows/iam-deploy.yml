name: Casdoor IAM Deploy

on:
  push:
    branches: [ main, master ]
    paths:
      - 'casdoor/**'
      - '.github/workflows/iam-deploy.yml'
    tags: [ 'iam-v*' ]
  pull_request:
    branches: [ main, master ]
    paths:
      - 'casdoor/**'
      - '.github/workflows/iam-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: fengyily/casdoor-iam
  CASDOOR_VERSION: latest
  CASDOOR_DOMAIN: iam.appsheild.net
  CASDOOR_URL: https://iam.appsheild.net

jobs:
  # ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  lint-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./casdoor
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache-dependency-path: casdoor/go.sum
        
    - name: Go mod download
      run: go mod download
      
    - name: Run go vet
      run: go vet ./...
      
    - name: Run tests
      run: |
        go test -v -race -coverprofile=coverage.out ./...
      continue-on-error: true
      
    - name: Upload coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: casdoor/coverage.out
        retention-days: 7

  # æ„å»º Docker é•œåƒ
  build:
    runs-on: ubuntu-latest
    needs: lint-and-test
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}},prefix=iam-
          type=semver,pattern={{major}}.{{minor}},prefix=iam-
          type=sha,prefix=sha-
          type=raw,value=latest,enable={{is_default_branch}}
        flavor: |
          latest=auto
          
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: ./casdoor
        file: ./casdoor/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
        sbom: false
        build-args: |
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}
          VERSION=${{ steps.meta.outputs.version }}

  # éƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/iam-v'))
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ vars.CASDOOR_URL }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create deployment files
      run: |
        mkdir -p deploy
        
        # åˆ›å»º docker-compose ç”Ÿäº§é…ç½®
        cat > deploy/docker-compose.yml << 'EOF'
        version: '3.8'
        
        services:
          casdoor:
            container_name: casdoor-server
            image: ${DOCKER_IMAGE}:${IMAGE_TAG:-latest}
            restart: always
            entrypoint: /bin/sh -c './server --createDatabase=true'
            ports:
              - "8000:8000"
            depends_on:
              postgres:
                condition: service_healthy
            environment:
              RUNNING_IN_DOCKER: "true"
            volumes:
              - ./conf/app.conf:/conf/app.conf:ro
              - casdoor-logs:/logs
            networks:
              - casdoor-network
            healthcheck:
              test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
              interval: 30s
              timeout: 10s
              retries: 3
              start_period: 60s
        
          postgres:
            container_name: casdoor-postgres
            image: postgres:15-alpine
            restart: always
            environment:
              POSTGRES_USER: ${POSTGRES_USER}
              POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
              POSTGRES_DB: ${POSTGRES_DB}
              PGDATA: /var/lib/postgresql/data/pgdata
            volumes:
              - postgres-data:/var/lib/postgresql/data
            networks:
              - casdoor-network
            healthcheck:
              test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
              interval: 10s
              timeout: 5s
              retries: 5
              start_period: 10s
        
        volumes:
          postgres-data:
            driver: local
          casdoor-logs:
            driver: local
        
        networks:
          casdoor-network:
            driver: bridge
        EOF
        
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy/deploy.sh << 'DEPLOY_EOF'
        #!/bin/bash
        set -e
        
        DEPLOY_DIR="/opt/casdoor"
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½² Casdoor..."
        
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        sudo mkdir -p $DEPLOY_DIR/conf
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        sudo cp /tmp/docker-compose.yml $DEPLOY_DIR/
        sudo cp /tmp/app.conf $DEPLOY_DIR/conf/
        
        cd $DEPLOY_DIR
        
        # ç™»å½•åˆ° GitHub Container Registry
        echo "$GITHUB_TOKEN" | sudo docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
        
        # æ‹‰å–æœ€æ–°é•œåƒ
        sudo docker-compose pull casdoor
        
        # åœæ­¢æ—§å®¹å™¨å¹¶å¯åŠ¨æ–°å®¹å™¨
        sudo docker-compose down --remove-orphans || true
        sudo docker-compose up -d
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30
        
        # å¥åº·æ£€æŸ¥
        for i in {1..10}; do
          if curl -sf http://localhost:8000/api/health > /dev/null 2>&1; then
            echo "âœ… Casdoor æœåŠ¡å·²æˆåŠŸå¯åŠ¨!"
            exit 0
          fi
          echo "ç­‰å¾…æœåŠ¡å°±ç»ª... ($i/10)"
          sleep 10
        done
        
        echo "âŒ æœåŠ¡å¯åŠ¨è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        sudo docker-compose logs --tail=50
        exit 1
        DEPLOY_EOF
        
        chmod +x deploy/deploy.sh
        
    - name: Generate production config
      run: |
        cat > deploy/app.conf << EOF
        appname = casdoor
        httpport = 8000
        runmode = prod
        copyrequestbody = true
        
        # PostgreSQL æ•°æ®åº“é…ç½®
        driverName = postgres
        dataSourceName = "user=${POSTGRES_USER} password=${POSTGRES_PASSWORD} host=postgres port=5432 sslmode=disable dbname=${POSTGRES_DB}"
        dbName = ${POSTGRES_DB}
        
        tableNamePrefix =
        showSql = false
        redisEndpoint =
        defaultStorageProvider =
        isCloudIntranet = false
        authState = "casdoor"
        socks5Proxy = ""
        verificationCodeTimeout = 10
        initScore = 0
        logPostOnly = true
        isUsernameLowered = false
        origin = "https://iam.appsheild.net"
        originFrontend = "https://iam.appsheild.net"
        staticBaseUrl = "https://cdn.casbin.org"
        isDemoMode = false
        batchSize = 100
        enableErrorMask = true
        enableGzip = true
        inactiveTimeoutMinutes =
        ldapServerPort = 389
        ldapsCertId = ""
        ldapsServerPort = 636
        radiusServerPort = 1812
        radiusDefaultOrganization = "built-in"
        radiusSecret = "${RADIUS_SECRET:-secret}"
        quota = {"organization": -1, "user": -1, "application": -1, "provider": -1}
        logConfig = {"adapter":"file", "filename": "logs/casdoor.log", "maxdays":99999, "perm":"0770"}
        initDataNewOnly = false
        initDataFile = "./init_data.json"
        frontendBaseDir = "../cc_0"
        EOF
      env:
        POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'casdoor' }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'casdoor' }}
        RADIUS_SECRET: ${{ secrets.RADIUS_SECRET }}
        
    - name: Deploy to Server
      env:
        SERVER_HOST: ${{ secrets.IAM_SERVER_HOST }}
        SERVER_USER: ${{ secrets.IAM_SERVER_USER }}
        SERVER_SSH_KEY: ${{ secrets.IAM_SERVER_SSH_KEY }}
        DOCKER_IMAGE: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        IMAGE_TAG: ${{ needs.build.outputs.image-tag }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'casdoor' }}
        POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'casdoor' }}
        GITHUB_TOKEN: ${{ secrets.GHCR_TOKEN }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        # é…ç½® SSH
        mkdir -p ~/.ssh
        echo "$SERVER_SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts
        
        echo "ğŸš€ éƒ¨ç½²åˆ° $SERVER_HOST..."
        
        # ä¸Šä¼ éƒ¨ç½²æ–‡ä»¶
        scp deploy/docker-compose.yml $SERVER_USER@$SERVER_HOST:/tmp/
        scp deploy/app.conf $SERVER_USER@$SERVER_HOST:/tmp/
        scp deploy/deploy.sh $SERVER_USER@$SERVER_HOST:/tmp/
        
        # æ‰§è¡Œéƒ¨ç½²
        ssh $SERVER_USER@$SERVER_HOST "
          export DOCKER_IMAGE='$DOCKER_IMAGE'
          export IMAGE_TAG='$IMAGE_TAG'
          export POSTGRES_USER='$POSTGRES_USER'
          export POSTGRES_PASSWORD='$POSTGRES_PASSWORD'
          export POSTGRES_DB='$POSTGRES_DB'
          export GITHUB_TOKEN='$GITHUB_TOKEN'
          export GITHUB_ACTOR='$GITHUB_ACTOR'
          chmod +x /tmp/deploy.sh
          /tmp/deploy.sh
        "
        
        # æ¸…ç† SSH å¯†é’¥
        rm -f ~/.ssh/id_rsa
        
        echo "âœ… éƒ¨ç½²å®Œæˆ!"
        
    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Casdoor IAM éƒ¨ç½²æˆåŠŸ!"
          echo "ğŸ”— è®¿é—®åœ°å€: ${{ vars.CASDOOR_URL }}"
        else
          echo "âŒ Casdoor IAM éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image-tag }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'
      continue-on-error: true
      
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

